FROM ubuntu:20.04

RUN apt update && DEBIAN_FRONTEND=noninteractive apt install -y isc-dhcp-server net-tools iputils-ping iproute2

COPY dhcpd6.conf /etc/dhcp/dhcpd6.conf

RUN mkdir -p /var/lib/dhcp && touch /var/lib/dhcp/dhcpd6.leases

# Create entrypoint script
RUN echo '#!/bin/bash\n\
# Get the interface name\n\
IFACE=$(ip -o -6 route show to default | awk "{print \$5}")\n\
if [ -z "$IFACE" ]; then\n\
  IFACE=$(ip -6 addr | grep "scope link" | head -1 | awk "{print \$2}" | cut -d: -f1)\n\
fi\n\
echo "Starting DHCPv6 server on interface: $IFACE"\n\
\n\
# Enable IPv6 forwarding\n\
echo 1 > /proc/sys/net/ipv6/conf/all/forwarding\n\
\n\
# Run dhcpd in foreground mode with IPv6\n\
exec dhcpd -f -d -6 --no-pid $IFACE\n\
' > /entrypoint6.sh

RUN chmod +x /entrypoint6.sh

CMD ["/entrypoint6.sh"]